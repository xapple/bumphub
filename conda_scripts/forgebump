#!/usr/bin/env python3
# -*- coding: utf8 -*-

"""
A script to automatically submit a package to conda-forge.
See the README.md file for more information.

Written by Lucas Sinclair.
MIT Licensed.
Contact at www.sinclair.bio
"""

# Built-in modules #
import sys

# Internal modules #
from __init__ import get_args

# Third party modules #
import sh
from autopaths import Path

# Constants #
__version__ = '0.9.0'
GITHUB_USER = 'xapple'

# Get command line arguments #
doc = sys.modules[__name__].__doc__
base_dir, proj_name, code_dir, toml_path, test_mode = get_args(doc)

# We need to make sure that all executables are available #
gh = sh.Command('gh')
git = sh.Command('git')

# Print start #
print("Packaging '%s' for conda-forge submission." % proj_name)
print("---------------------------")

###############################################################################
# Fork the main repo (will skip if already forked) #
staged_name = 'conda-forge/staged-recipes'
args = ['repo', 'fork', staged_name, '--clone=false']
print("Checking that '%s' is forked." % staged_name)
gh(*args, _out=sys.stdout, _err=sys.stderr)

# Now check we have a checked out copy of the repo (about 200MB) #
staged_repo = Path("~/repos/staged-recipes/")
if not staged_repo.exists:
    url = 'https://github.com/xapple/staged-recipes'
    print("Cloning '%s' to '%s'." % (url, staged_repo))
    args = ['clone', url, staged_repo]
    git(*args, _out=sys.stdout, _err=sys.stderr)

###############################################################################
with sh.pushd(str(staged_repo)):
    # Create a branch #
    branch_name = f"add-{proj_name}"
    git.checkout("-b", branch_name)

    # Create recipe directory #
    recipe_dir = staged_repo + "recipes" + proj_name
    recipe_dir.create_if_not_exists()

    # Copy generated recipe #
    pass

    # git add / commit / push
    git.add(recipe_dir)
    git.commit("-m", f"Add {proj_name}")
    git.push("-u", GITHUB_USER, branch_name)

    # create PR
    #gh("pr", "create", "--repo", "conda-forge/staged-recipes", "--title",   f"Add {proj_name}", "--body", f"Adding {proj_name} from PyPI.", "--head",f"{GITHUB_USER}:{branch_name}", )