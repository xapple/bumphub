#!/usr/bin/env python2
# -*- coding: utf8 -*-

# Built-in modules #
import os, sys, argparse, shutil

# First party modules #
from plumbing.git import GitRepo

# Third party modules #
import sh
import pkgtools.pypi
from dialog import Dialog

# Constants #
__version__ = '1.0.2'

# Parse the shell arguments #
parser = argparse.ArgumentParser(description=sys.modules[__name__].__doc__)
parser.add_argument("module", help="The name of the module to process", type=str)
args = parser.parse_args()
module_name = args.module

# Directories #
base_dir = os.path.expanduser("~/repos/%s/" % module_name)
code_dir = base_dir + module_name + '/'

# The repository #
repo = GitRepo(base_dir)

################################################################################
### Bump the version ###
# The module itself must be importable #
module = __import__(module_name)

# Current version #
v_current = module.__version__

# Compute parts #
maj, mid, fix = map(int, v_current.rstrip('dev').split('.'))

# Functions #
def numbers_to_string(maj, mid, fix):
    return '.'.join(map(str, (maj, mid, fix)))

def plus_one_to_version(maj, mid, fix):
    maj_next = maj
    mid_next = mid
    fix_next = fix+1
    if fix_next > 9:
        fix_next = 0
        mid_next = mid+1
    return maj_next, mid_next, fix_next

# Next version #
maj_next, mid_next, fix_next = plus_one_to_version(maj, mid, fix)
v_next = numbers_to_string(maj_next, mid_next, fix_next)

# Dev version #
maj_dev, mid_dev, fix_dev = plus_one_to_version(maj_next, mid_next, fix_next)
v_dev = numbers_to_string(maj_dev, mid_dev, fix_dev)

# Messages #
print "---------------------------"
print '-> Versions overview'
print 'Current version: %s' % v_current
print 'Next version:    %s' % v_next
print 'Dev version:     %s' % v_dev

# Function #
def run_gsed(base, find, repl, path):
    find = find.replace('.', '\.')
    sh.gsed('-i', base % (find, repl), path)

def replace_everywhere(vcrnt, vnext):
    # Replace in __init__.py #
    path = code_dir + '__init__.py'
    base = "s/^%s/%s/g"
    find = "__version__ = '%s'" % vcrnt
    repl = "__version__ = '%s'" % vnext
    run_gsed(base, find, repl, path)

    # Replace in setup.py #
    path = base_dir + 'setup.py'
    base = "s/%s$/%s/g"
    find = vcrnt + "',"
    repl = vnext + "',"
    run_gsed(base, find, repl, path)

    # Replace in README #
    path = base_dir + 'README.md'
    base = "s/%s$/%s/g"
    find = "` version %s" % vcrnt
    repl = "` version %s" % vnext
    run_gsed(base, find, repl, path)

# Messages #
print "---------------------------"
print "-> Replacing everywhere"

# Bump the version #
replace_everywhere(v_current, v_next)

# Add the files #
repo.add(module_name + '/' + '__init__.py')
repo.add('setup.py')
repo.add('README.md')

# Messages #
print "---------------------------"
print "-> Committing"

# Commit #
message = 'Version %s' % v_next
print repo.commit(message)

# Tag #
repo.tag_head(v_next)

print "---------------------------"
print "-> Pushing"

# Push #
print repo.push(shell=True)
print repo.push(tags=True, shell=True)

################################################################################
### Submit to PyPI ###
# Change directory #
os.chdir(base_dir)

# API to pypi #
pypi_api = pkgtools.pypi.PyPIXmlRpc()
releases = pypi_api.package_releases(module_name)

# Register it #
if not releases:
    title  = "PyPI upload"
    msg    = "The packages '%s' seems to not be registered with PyPI, register it ?"
    d      = Dialog(dialog="dialog")
    d.set_background_title(title)
    answer = d.yesno(msg)
    if answer != d.OK: sys.exit()
    sh.python('setup.py', 'register', '-r', 'pypi')

# Message #
print "--------------------------"
print "-> Building distribution"

# Build it #
print sh.python('setup.py', 'sdist', 'bdist_wheel')

# Message #
print "--------------------------"
print "-> Uploading using twine"

# Upload it #
print sh.twine('upload', 'dist/*.whl')

# Message #
print "--------------------------"
print "-> Cleaning up"

# Clean up #
manifest_file   = base_dir + 'MANIFEST'
dist_directory  = base_dir + 'dist/'
build_directory = base_dir + 'build/'
egg_directory  = base_dir + module_name + '.egg-info/'

if os.path.exists(manifest_file):   os.remove(manifest_file)
if os.path.exists(dist_directory):  shutil.rmtree(dist_directory)
if os.path.exists(build_directory): shutil.rmtree(build_directory)
if os.path.exists(egg_directory):   shutil.rmtree(egg_directory)

################################################################################
# Messages #
print "---------------------------"
print "-> Replacing everywhere (dev)"

# Return to development version #
replace_everywhere(v_next, v_dev)

# Add the files #
repo.add(module_name + '/' + '__init__.py')
repo.add('setup.py')
repo.add('README.md')

# Commit #
message = 'Back to development version.'
print repo.commit(message)

# Messages #
print "---------------------------"
print "-> Pushing (dev)"

# Push #
print repo.push(shell=True)